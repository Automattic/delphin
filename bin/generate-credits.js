/* eslint-disable quote-props */
const { flow } = require( 'lodash' );
const fs = require( 'fs' );
const nlf = require( 'nlf' );
const path = require( 'path' );
const { dependencies, devDependencies } = require( '../package.json' );
const allDependencies = Object.keys( Object.assign( {}, devDependencies, dependencies ) );
const projectRoot = path.dirname( __dirname );

function extractLicenceInformation( data ) {
	return data.reduce( ( result, module ) => {
		if ( allDependencies.includes( module.name ) ) {
			if ( ! result[ module.summary() ] ) {
				result[ module.summary() ] = {};
			}

			result[ module.summary() ][ module.name ] = module.repository;
		}

		return result;
	}, {} );
}

function formatLicenseInformation( licenseInformation ) {
	const output = [
		'<!-- This file is automatically generated using `yarn run credits`. -->',
		'Credits',
		'=======',
		'This project makes use of the Open Source packages listed below (see [package.json](/package.json) for a list that is always up-to-date). Their source code and detailed license information are available from [NPM](https://npmjs.org) or [GitHub](https://github.com/). Many thanks to all of the original authors!',
		'',
	];

	Object.keys( licenseInformation ).sort().forEach( ( license ) => {
		const packages = licenseInformation[ license ];
		output.push( `### ${ license }` );
		Object.keys( packages ).forEach( ( name ) => {
			output.push( `* ${ name }: ${ packages[ name ] }` );
		} );
		output.push( '' );
	} );

	return output.join( '\n' );
}

function saveOutput( output ) {
	fs.writeFile( `${ projectRoot }/CREDITS.md`, output, ( error ) => {
		if ( error ) {
			throw error;
		}

		console.log( 'Generated CREDITS.md file.' );
	} );
}

nlf.find( {
	directory: projectRoot,
	summaryMode: 'off',
}, ( error, data ) => {
	if ( error ) {
		throw error;
	}

	flow( extractLicenceInformation, formatLicenseInformation, saveOutput )( data );
} );
